# NGINX with RTMP Module Configuration for WedLive
# This configuration is for NGINX compiled with nginx-rtmp-module
# 
# INSTALLATION STEPS:
# 1. Install NGINX with RTMP module:
#    sudo apt-get update
#    sudo apt-get install -y libnginx-mod-rtmp
# 
# 2. Or compile from source with RTMP module (see nginx-implementation.md)
# 
# 3. Copy this file to /etc/nginx/nginx.conf
# 4. Create required directories:
#    sudo mkdir -p /tmp/hls /tmp/dash /tmp/recordings
#    sudo chmod 777 /tmp/hls /tmp/dash /tmp/recordings
# 
# 5. Restart NGINX:
#    sudo systemctl restart nginx
#    sudo systemctl status nginx

user www-data;
worker_processes auto;
pid /run/nginx.pid;
rtmp_auto_push on;
error_log /var/log/nginx/error.log;

events {
    worker_connections 1024;
    use epoll;
}

# RTMP Configuration
rtmp {
    server {
        listen 1935;
        chunk_size 4096;
        
        # WedLive streaming application
        application live {
            live on;
            record off;  # Recording handled by backend service
            
            # Enable HLS
            hls on;
            hls_path /tmp/hls;
            hls_fragment 3s;
            hls_playlist_length 60s;
            hls_continuous on;
            hls_cleanup on;
            hls_nested on;
            
            # Enable DASH (optional)
            dash on;
            dash_path /tmp/dash;
            dash_fragment 3s;
            dash_playlist_length 60s;
            dash_cleanup on;
            dash_nested on;
            
            # Webhooks to WedLive backend
            # These are called when streams start/stop
            on_publish http://localhost:8001/api/rtmp/on-publish;
            on_publish_done http://localhost:8001/api/rtmp/on-publish-done;
            on_update http://localhost:8001/api/rtmp/on-update;
            
            # Security: Allow publishing only from localhost or specific IPs
            # Uncomment and configure for production
            # allow publish 127.0.0.1;
            # allow publish YOUR_OBS_IP_RANGE;
            # deny publish all;
            
            # Allow playing from anywhere
            allow play all;
            
            # Recording configuration (if backend doesn't handle it)
            # record all;
            # record_path /tmp/recordings;
            # record_suffix _%Y-%m-%d_%H-%M-%S.flv;
            # record_unique on;
            
            # Timeout settings
            idle_streams off;
        }
        
        # Test application (for development)
        application test {
            live on;
            record off;
            allow publish all;
            allow play all;
        }
    }
}

# HTTP Configuration for HLS delivery
http {
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    # Logging
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;
    
    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript 
               application/json application/javascript application/xml+rss 
               application/rss+xml font/truetype font/opentype 
               application/vnd.ms-fontobject image/svg+xml;
    
    # HLS delivery server
    server {
        listen 8080;
        server_name localhost;
        
        # CORS headers for cross-origin HLS playback
        add_header Access-Control-Allow-Origin * always;
        add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS' always;
        add_header Access-Control-Allow-Headers 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range' always;
        add_header Access-Control-Expose-Headers 'Content-Length,Content-Range' always;
        
        # HLS streams
        location /hls {
            types {
                application/vnd.apple.mpegurl m3u8;
                video/mp2t ts;
            }
            root /tmp;
            add_header Cache-Control no-cache;
            add_header Access-Control-Allow-Origin * always;
        }
        
        # DASH streams
        location /dash {
            types {
                application/dash+xml mpd;
                video/mp4 m4s;
            }
            root /tmp;
            add_header Cache-Control no-cache;
            add_header Access-Control-Allow-Origin * always;
        }
        
        # Recordings (if served directly)
        location /recordings {
            types {
                video/x-flv flv;
                video/mp4 mp4;
            }
            root /tmp;
            add_header Cache-Control no-cache;
            add_header Access-Control-Allow-Origin * always;
        }
        
        # RTMP statistics (optional)
        location /stat {
            rtmp_stat all;
            rtmp_stat_stylesheet stat.xsl;
        }
        
        location /stat.xsl {
            root /usr/share/nginx/html;
        }
        
        # Health check
        location /health {
            access_log off;
            return 200 "OK\n";
            add_header Content-Type text/plain;
        }
    }
    
    # Production HTTPS server (configure after getting SSL certificate)
    # server {
    #     listen 443 ssl http2;
    #     server_name your-domain.com;
    #     
    #     ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
    #     ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;
    #     
    #     location /hls {
    #         types {
    #             application/vnd.apple.mpegurl m3u8;
    #             video/mp2t ts;
    #         }
    #         root /tmp;
    #         add_header Cache-Control no-cache;
    #         add_header Access-Control-Allow-Origin * always;
    #     }
    # }
    
    # Include other server configs
    include /etc/nginx/conf.d/*.conf;
    include /etc/nginx/sites-enabled/*;
}
